// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  CUSTOMER
  TELLER
  LOAN_OFFICER
  ADMIN
  SUPERADMIN
}

enum AccountStatus {
  PENDING
  ACTIVE
  FROZEN
  CLOSED
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  REVERSED
}

enum TransactionType {
  DEPOSIT
  WITHDRAWAL
  TRANSFER
  LOAN_DISBURSEMENT
  LOAN_REPAYMENT
}

enum KycStatus {
  PENDING
  VERIFIED
  REJECTED
}

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  password      String
  role          Role      @default(CUSTOMER)
  isMfaEnabled  Boolean   @default(false)
  mfaSecret     String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  profile       Profile?
  accounts      Account[]
  auditLogs     AuditLog[]
  goals         Goal[]
  loans         Loan[]
}

model Goal {
  id            String   @id @default(uuid())
  title         String
  targetAmount  Decimal  @db.Decimal(15, 2)
  currentAmount Decimal  @default(0) @db.Decimal(15, 2)
  currency      String   @default("GHS")
  deadline      DateTime?
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

enum LoanStatus {
  PENDING
  APPROVED
  REJECTED
  PAID
}

model Loan {
  id            String   @id @default(uuid())
  amount        Decimal  @db.Decimal(15, 2)
  type          String   // PERSONAL, BUSINESS, FARM
  status        LoanStatus @default(PENDING)
  interestRate  Decimal  @db.Decimal(5, 2)
  termMonths    Int
  purpose       String
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Profile {
  id            String    @id @default(uuid())
  userId        String    @unique
  user          User      @relation(fields: [userId], references: [id])
  firstName     String
  lastName      String
  phoneNumber   String    @unique
  address       String?
  dateOfBirth   DateTime?
  nationalId    String?   @unique // Encrypted
  kycLevel      Int       @default(1)
  kycStatus     KycStatus @default(PENDING)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model Account {
  id            String         @id @default(uuid())
  userId        String
  user          User           @relation(fields: [userId], references: [id])
  accountNumber String         @unique
  type          String         // SAVINGS, CURRENT, SUSU
  balance       Decimal        @default(0) @db.Decimal(15, 2)
  currency      String         @default("GHS")
  status        AccountStatus  @default(PENDING)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  
  // Relations for Double-Entry
  sentTransfers     Transaction[] @relation("SenderAccount")
  receivedTransfers Transaction[] @relation("ReceiverAccount")
}

model Transaction {
  id                String            @id @default(uuid())
  reference         String            @unique
  type              TransactionType
  amount            Decimal           @db.Decimal(15, 2)
  currency          String            @default("GHS")
  status            TransactionStatus @default(PENDING)
  description       String?
  idempotencyKey    String?           @unique
  
  senderAccountId   String?
  senderAccount     Account?          @relation("SenderAccount", fields: [senderAccountId], references: [id])
  
  receiverAccountId String?
  receiverAccount   Account?          @relation("ReceiverAccount", fields: [receiverAccountId], references: [id])
  
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
}

model AuditLog {
  id          String   @id @default(uuid())
  userId      String?
  user        User?    @relation(fields: [userId], references: [id])
  action      String   // e.g., "LOGIN", "TRANSFER_INITIATED"
  resource    String   // e.g., "ACCOUNT", "USER"
  resourceId  String?  // ID of the affected resource
  metadata    Json?    // Stores old/new values, IP, Browser
  createdAt   DateTime @default(now())

  @@map("audit_logs")
}
